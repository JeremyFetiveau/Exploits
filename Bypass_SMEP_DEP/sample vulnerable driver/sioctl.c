#include <ntddk.h>

#define DEVICE_NAME      L"\\Device\\KindDevice"
#define DOS_DEVICE_NAME  L"\\DosDevices\\KindDosDevice"

#define IOCTL_PWN  CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define IOCTL_PWN2 CTL_CODE(FILE_DEVICE_UNKNOWN, 0x801, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define IOCTL_PWN3 CTL_CODE(FILE_DEVICE_UNKNOWN, 0x802, METHOD_BUFFERED, FILE_ANY_ACCESS)

static PUINT64 what = NULL, where = NULL;

NTSTATUS ioctlHandler(
	PDEVICE_OBJECT DeviceObject,
	PIRP Irp
	)
{
	UNREFERENCED_PARAMETER(DeviceObject);
	PIO_STACK_LOCATION stack;
	ULONG ctl, inLen;
	PCHAR input = Irp->AssociatedIrp.SystemBuffer;
	
	stack = IoGetCurrentIrpStackLocation(Irp);

	ctl = stack->Parameters.DeviceIoControl.IoControlCode;
	inLen = stack->Parameters.DeviceIoControl.InputBufferLength;

	DbgPrint("Handling IOCTL\n");

	if (ctl == IOCTL_PWN)
	{
		DbgPrint("Content?");
		DbgPrint("Input len : %x\n", inLen);
		if (input)
		{
			DbgPrint("%16llx\n", *input);
			what = *(PUINT64*)input;
		}
	}
	else if (ctl == IOCTL_PWN2)
	{
		DbgPrint("Write address?");
		DbgPrint("Input len : %x\n", inLen);
		if (input)
		{
			DbgPrint("%16llx\n", *input);
			where = *(PUINT64*)input;
		}
	}
	else if (ctl == IOCTL_PWN3)
	{
		DbgPrint("Triggering ... Are you sure?\n");
		DbgBreakPoint();
		*where = (UINT64)what;
	}

	DbgPrint("What %016llx Where %016llx\n", what, where);

	Irp->IoStatus.Status = STATUS_SUCCESS;
	IoCompleteRequest(Irp, IO_NO_INCREMENT);
	return 0;
}

NTSTATUS openCloseHandler(
	PDEVICE_OBJECT DeviceObject,
	PIRP Irp
	)
{
	UNREFERENCED_PARAMETER(DeviceObject);
	Irp->IoStatus.Status = STATUS_SUCCESS;
	IoCompleteRequest(Irp, IO_NO_INCREMENT);
	return STATUS_SUCCESS;
}

NTSTATUS DriverEntry(
	IN PDRIVER_OBJECT DriverObject,
	IN PUNICODE_STRING RegistryPath
	)
{
	UNREFERENCED_PARAMETER(RegistryPath);
	NTSTATUS st;
	PDEVICE_OBJECT deviceObject;
	UNICODE_STRING deviceName, dosDeviceName;

	DbgPrint("Strawberries!\n");

	RtlInitUnicodeString(&deviceName, DEVICE_NAME);

	st = IoCreateDevice(
		DriverObject,
		0,
		&deviceName,
		FILE_DEVICE_UNKNOWN,
		0,
		FALSE,
		&deviceObject);

	if (!NT_SUCCESS(st))
	{
		DbgPrint("IoCreateDevice failed\n");
		return st;
	}

	DriverObject->MajorFunction[IRP_MJ_DEVICE_CONTROL] = ioctlHandler;
	DriverObject->MajorFunction[IRP_MJ_CREATE] = openCloseHandler;
	DriverObject->MajorFunction[IRP_MJ_CLOSE] = openCloseHandler;

	RtlInitUnicodeString(&dosDeviceName, DOS_DEVICE_NAME);
	st = IoCreateSymbolicLink(&dosDeviceName, &deviceName);

	if (!NT_SUCCESS(st))
	{
		DbgPrint("IoCreateSymbolicLink failed\n");
		if (deviceObject)
			IoDeleteDevice(deviceObject);
		else
			DbgPrint("IoDeleteDevice failed\n");
		return st;
	}

	return st;
}