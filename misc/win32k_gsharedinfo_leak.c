typedef struct _tagSERVERINFO {
	UINT64 pad;
	UINT64 cbHandleEntries;
} SERVERINFO, *PSERVERINFO;

typedef struct _HANDLEENTRY {
	PVOID pHeader;
	PVOID pOwner;
	UCHAR bType;
	UCHAR bFlags;
	USHORT wUniq;
} HANDLEENTRY, *PHANDLEENTRY;

typedef struct _SHAREDINFO {
	PSERVERINFO psi;
	PHANDLEENTRY aheList;
} SHAREDINFO, *PSHAREDINFO;

char *types[] = { "TYPE_FREE", "TYPE_WINDOW", "TYPE_MENU", "TYPE_CURSOR", "TYPE_SETWINDOWPOS", "TYPE_HOOK", "TYPE_CLIPDATA", "TYPE_CALLPROC", "TYPE_ACCELTABLE", 
				  "TYPE_DDEACCESS", "TYPE_DDECONV", "TYPE_DDEXACT", "TYPE_MONITOR", "TYPE_KBDLAYOUT", "TYPE_KDBFILE", "TYPE_WINEVENTHOOK", "TYPE_TIMER",
				  "TYPETYPE_INPUTCONTEXT", "TYPE_CTYPES", "TYPE_GENERIC"};

void printHandle(HANDLEENTRY entry) {
	if (entry.bType)
		printf("%llp %llp %s(%d)\n", entry.pHeader, entry.pOwner, types[entry.bType], entry.bType);
}

void showWin32kUserHandleTable()
{
	HMODULE usermod;
	PSHAREDINFO gSharedInfo;
	INT i;
		
	usermod = LoadLibraryA("user32.dll");
	gSharedInfo = (PSHAREDINFO)GetProcAddress(usermod, "gSharedInfo");

	for (i = 0; i < gSharedInfo->psi->cbHandleEntries; ++i)
	{
		printHandle(gSharedInfo->aheList[i]);
	}
}
//http://volatility-labs.blogspot.fr/2012/09/movp-33-analyzing-user-handles-and.html
//https://media.blackhat.com/bh-us-11/Mandt/BH_US_11_Mandt_win32k_WP.pdf
